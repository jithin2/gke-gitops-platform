name: Deploy

on:
  # Runs automatically after CI completes on main
  workflow_run:
    workflows: ["CI — Build & Push Images"]
    types: [completed]
    branches: [main]

  # Also allows manual trigger with custom inputs
  workflow_dispatch:
    inputs:
      environment:
        description: 'Which environment to deploy to?'
        required: true
        type: choice
        options: [dev, staging, prod]

jobs:

  # ── DEPLOY TO DEV (automatic) ──────────────────────────────
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || inputs.environment == 'dev' }}
    environment: dev       # injects dev secrets, shows in dev deployment history
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Show what's being deployed
        run: |
          echo "=== Deploying to DEV ==="
          echo "Target: ${{ secrets.DEPLOY_TARGET }}"
          echo "Image tags:"
          cat helm/gitops-platform/values-ghcr.yaml || echo "values-ghcr.yaml not found yet"

      - name: Confirm ArgoCD will auto-sync
        run: |
          echo "ArgoCD watches the repo and will sync within 3 minutes"
          echo "Run: kubectl get pods -n dev -w  (to watch rollout)"

  # ── DEPLOY TO STAGING (after dev) ─────────────────────────
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: |
      always() &&
      (needs.deploy-dev.result == 'success' || needs.deploy-dev.result == 'skipped') &&
      (github.event.workflow_run.conclusion == 'success' || inputs.environment == 'staging')
    environment: staging   # injects staging secrets
    steps:
      - name: Deploy to staging
        run: |
          echo "=== Deploying to STAGING ==="
          echo "Target: ${{ secrets.DEPLOY_TARGET }}"

  # ── DEPLOY TO PROD (requires approval) ────────────────────
  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: |
      always() &&
      (needs.deploy-staging.result == 'success' || needs.deploy-staging.result == 'skipped') &&
      (github.event.workflow_run.conclusion == 'success' || inputs.environment == 'prod')
    environment: prod      # PAUSES HERE and waits for manual approval
    steps:
      - name: Deploy to prod
        run: |
          echo "=== Deploying to PRODUCTION ==="
          echo "Target: ${{ secrets.DEPLOY_TARGET }}"
          echo "Approved by: ${{ github.actor }}"